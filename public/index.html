<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zizu - Real Estate Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand: #004225;
      --brand-strong: #006837;
      --overlay-bg: rgba(0,0,0,0.45);
    }
    html,body{height:100%;margin:0;}
    body {
      font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #fdf6e3;
      display:flex;
      justify-content:center;
      padding:20px;
      box-sizing:border-box;
    }

    .chat-box {
      width:100%;
      max-width:680px;
      background:#fff;
      border-radius:12px;
      padding:20px;
      box-shadow:0 8px 28px rgba(0,0,0,0.08);
      box-sizing:border-box;
    }

    .bot-title { text-align:center; color:var(--brand); font-size:26px; margin:0 0 12px; font-weight:600; }

    #messages {
      max-height:420px;
      overflow:auto;
      padding-right:6px;
      margin-bottom:12px;
    }
    .message {
      margin-bottom:10px;
      padding:12px;
      border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.06);
      line-height:1.4;
      word-break:break-word;
      animation: fadeIn .18s ease;
    }
    .message.user { background:var(--brand); color:#fff; text-align:right; }
    .message.bot  { background:#eaf5fb; color:#073038; text-align:left; }

    @keyframes fadeIn { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

    .quick-buttons { display:flex; gap:10px; margin-bottom:12px; flex-wrap:wrap; }
    .quick-buttons button {
      flex:1 1 auto;
      min-width:110px;
      padding:10px 14px;
      border-radius:8px;
      border:0;
      background:var(--brand);
      color:#fff;
      cursor:pointer;
      transition: transform .12s, background .12s;
    }
    .quick-buttons button:hover{ background:var(--brand-strong) }
    .quick-buttons button.active { background:#00994d; transform:scale(1.04) }

    .input-container { display:flex; gap:10px; align-items:center; }
    .input-container input { flex:1 1 auto; padding:10px; border-radius:8px; border:1px solid #ddd; font-size:15px; }
    .input-container button { padding:10px 14px; border-radius:8px; font-size:15px; border:0; background:var(--brand); color:#fff; cursor:pointer; }
    .input-container button:disabled { opacity:.5; cursor:not-allowed; }

    /* Overlay & modal */
    #contactOverlay {
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:var(--overlay-bg);
      visibility:hidden; opacity:0;
      transition: opacity 220ms ease, visibility 220ms;
      z-index:1200;
    }
    #contactOverlay.visible { visibility:visible; opacity:1; }

    .contact-form {
      width:420px; max-width:92%;
      background:#fff; border-radius:12px;
      padding:20px; box-sizing:border-box;
      box-shadow:0 12px 40px rgba(0,0,0,0.12);
      transform:translateY(-10px);
      opacity:0;
      transition: transform 220ms ease, opacity 220ms ease;
      position:relative;
    }
    #contactOverlay.visible .contact-form { transform:none; opacity:1; }

    /* Close button (compact) */
    .contact-form .close-btn {
      position:absolute;
      top:12px;
      right:12px;
      width:36px;
      height:36px;
      padding:0;
      border-radius:50%;
      border:1px solid rgba(0,0,0,0.06);
      background:#fff;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,0.06);
      font-size:16px;
      color:#444;
    }
    .contact-form .close-btn:hover { background:#f2f2f2; }

    .contact-form h3 { margin:6px 0 12px; color:var(--brand); font-size:16px; text-align:center; }
    .contact-form input, .contact-form select, .contact-form textarea {
      width:100%; box-sizing:border-box; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #e0e0e0; font-size:15px; font-family:inherit;
    }
    .contact-form textarea { min-height:88px; resize:vertical; }

    /* only submit button gets full width */
    .contact-form .submit-btn {
      width:100%;
      padding:12px;
      border-radius:8px;
      border:0;
      background:var(--brand);
      color:#fff;
      font-size:15px;
      cursor:pointer;
    }
    .contact-form .submit-btn:hover { background:var(--brand-strong) }

    #submitStatus { text-align:center; margin-top:8px; font-size:14px; color:#333; }

    @media (max-width:480px) {
      .contact-form { padding:16px; }
      .contact-form .close-btn { width:32px; height:32px; top:10px; right:10px; font-size:15px; }
    }
  </style>
</head>
<body>
  <div class="chat-box" role="main" aria-labelledby="chatTitle">
    <h1 id="chatTitle" class="bot-title">üè† Zizu Real Estate Assistant</h1>

    <div class="quick-buttons" role="tablist" aria-label="Scenarios">
      <button id="buyBtn" data-scenario="buy">üè† Buy</button>
      <button id="rentBtn" data-scenario="rent">üì¶ Rent</button>
      <button id="sellBtn" data-scenario="sell">üíº Sell</button>
    </div>

    <div id="messages" aria-live="polite"></div>

    <div class="input-container">
      <input id="userInput" placeholder="Please select an action above" autocomplete="off" disabled />
      <button id="sendBtn" disabled>Send</button>
      <button id="leadBtn">üìã Leave Contact</button>
    </div>
  </div>

  <div id="contactOverlay" aria-hidden="true">
    <div class="contact-form" role="dialog" aria-modal="true" aria-labelledby="leadTitle">
      <button type="button" class="close-btn" aria-label="Close" id="closeModal">‚úñ</button>
      <h3 id="leadTitle">üìã Leave your contact details ‚Äî our manager will get in touch with you shortly.</h3>

      <input id="leadName" placeholder="Your name" />
      <input id="leadEmail" placeholder="Email" type="email" />
      <input id="leadPhone" placeholder="Phone number" />
      <select id="leadPlanning">
        <option value="">Planning horizon</option>
        <option value="Urgent">Urgent</option>
        <option value="1-2 months">1‚Äì2 months</option>
        <option value="3-5 months">3‚Äì5 months</option>
      </select>
      <textarea id="leadDescription" placeholder="Brief description of the apartment and area"></textarea>

      <button class="submit-btn" id="submitLeadBtn">Submit</button>
      <div id="submitStatus" role="status" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // Elements
    const messagesDiv = document.getElementById('messages');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const leadBtn = document.getElementById('leadBtn');
    const overlay = document.getElementById('contactOverlay');
    const closeModal = document.getElementById('closeModal');
    const submitLeadBtn = document.getElementById('submitLeadBtn');
    const sessionId = 'session_' + Date.now();

    let messageCount = 0;
    let currentScenario = null;

    // utility: escape HTML
    function escapeHTML(str){
      return String(str).replace(/[&<>"']/g, s => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
    }

    // append messages
    function appendMessage(text, from='bot'){
      const cls = from === 'user' ? 'user' : 'bot';
      messagesDiv.insertAdjacentHTML('beforeend', `<div class="message ${cls}">${escapeHTML(text)}</div>`);
      // smooth scroll
      messagesDiv.scrollTo({ top: messagesDiv.scrollHeight, behavior: 'smooth' });
    }

    // scenario switching
    function setActiveButton(btn){
      document.querySelectorAll('.quick-buttons button').forEach(b => b.classList.remove('active'));
      if(btn) btn.classList.add('active');
    }

    function startScenario(scenario){
      currentScenario = scenario;
      const btn = document.querySelector(`.quick-buttons button[data-scenario="${scenario}"]`);
      setActiveButton(btn);
      userInput.disabled = false;
      userInput.placeholder = 'Type your message...';
      userInput.focus();

      if(scenario === 'buy') appendMessage("Hello! I'm Zizu, your real estate assistant in Hurghada. We have over 100 properties available for purchase ‚Äî apartments, villas, and compounds. What are you looking for?");
      if(scenario === 'rent') appendMessage("Hi! I'm Zizu, your rental assistant in Hurghada. Let's find the perfect place for you. Which area, how many bedrooms, rental timeline?");
      if(scenario === 'sell'){ openForm(); appendMessage("Great! To help you sell your property, please leave your contact details and a brief description of the apartment and its location."); }
    }

    // overlay show/hide
    function openForm(){
      overlay.classList.add('visible');
      overlay.setAttribute('aria-hidden','false');
      // focus first input inside
      setTimeout(()=> document.getElementById('leadName').focus(), 120);
    }
    function closeForm(){
      overlay.classList.remove('visible');
      overlay.setAttribute('aria-hidden','true');
    }

    // wire scenario buttons
    document.querySelectorAll('.quick-buttons button').forEach(btn=>{
      btn.addEventListener('click', ()=> startScenario(btn.dataset.scenario));
    });

    // wire lead button and close
    leadBtn.addEventListener('click', openForm);
    closeModal.addEventListener('click', closeForm);
    // click outside to close
    overlay.addEventListener('click', (e)=> { if(e.target === overlay) closeForm(); });
    // esc to close
    document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') closeForm(); });

    // send button enabled only with text
    userInput.addEventListener('input', ()=> { sendBtn.disabled = !userInput.value.trim(); });

    // Enter to send
    userInput.addEventListener('keypress', (e)=> { if(e.key === 'Enter'){ e.preventDefault(); sendMessage(); }});
    sendBtn.addEventListener('click', sendMessage);

    // send message to server
    async function sendMessage(){
      const text = userInput.value.trim();
      if(!text) return;
      appendMessage(text, 'user');
      userInput.value = '';
      sendBtn.disabled = true;
      messageCount++;

      // after each 4th message open form
      if(messageCount % 4 === 0) openForm();

      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ message: text, sessionId, scenario: currentScenario })
        });

        if(!res.ok) {
          const errText = await res.text().catch(()=>res.statusText || 'Server error');
          throw new Error('Server returned ' + res.status + ': ' + errText);
        }

        const data = await res.json();
        appendMessage(data.reply || 'No reply from server');
        if(data.showContactForm) openForm();
      } catch (err) {
        console.error('Chat error:', err);
        appendMessage('‚ö†Ô∏è Error connecting to server. Please check your connection or try again later.');
      }
    }

    // lead submit
    submitLeadBtn.addEventListener('click', submitLead);
    async function submitLead(){
      const name = document.getElementById('leadName').value.trim();
      const email = document.getElementById('leadEmail').value.trim();
      const phone = document.getElementById('leadPhone').value.trim();
      const planning = document.getElementById('leadPlanning').value;
      const description = document.getElementById('leadDescription').value.trim();
      const statusDiv = document.getElementById('submitStatus');

      const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if(!name || !emailRe.test(email) || !phone){
        alert('Please enter a valid name, email and phone.');
        return;
      }

      statusDiv.textContent = 'üîÑ Sending...';
      try {
        const res = await fetch('/lead', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name, email, phone, planning, description, sessionId, scenario: currentScenario })
        });
        if(!res.ok) {
          const t = await res.text().catch(()=>res.statusText);
          throw new Error('Lead error: ' + t);
        }
        statusDiv.textContent = '‚úÖ Thank you! We will contact you soon.';
        setTimeout(()=>{ statusDiv.textContent=''; closeForm(); }, 1200);
      } catch(err){
        console.error('Lead send error:', err);
        statusDiv.textContent = '‚ö†Ô∏è Error sending data. Please try again later.';
      }
    }

    // phone input validation
    document.getElementById('leadPhone').addEventListener('input', (e)=> {
      e.target.value = e.target.value.replace(/[^0-9+()\- \s]/g,'');
    });

    // initial small welcome (optional)
    // appendMessage("Welcome! Choose Buy / Rent / Sell to start.");
  </script>
</body>
</html>
