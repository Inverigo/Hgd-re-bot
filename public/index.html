<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zizu â€” Real Estate Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #f4efe3;
    --card: #ffffff;
    --brand: #0b5a34;
    --brand-strong: #0d7a45;
    --muted: #8d8d8d;
  }
  html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:var(--bg);}
  .page {max-width:920px;margin:28px auto;padding:18px;}
  .chat-box{
    background:var(--card);
    border-radius:14px;
    box-shadow:0 10px 30px rgba(6,6,6,0.08);
    padding:20px;
    display:flex;
    flex-direction:column;
    height:720px;
    box-sizing:border-box;
  }
  .header{display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:8px;}
  .title{font-size:24px;font-weight:600;color:var(--brand);margin:0;}
  .icon{width:28px;height:28px;flex:none;}
  .scenarios{display:flex;justify-content:center;gap:12px;margin:14px 0;}
  .scenarios button{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 16px;border-radius:10px;
    border:1px solid rgba(6,90,52,0.08);
    background:linear-gradient(180deg,#f7fbf7,#f0f7f0);
    color:var(--brand);cursor:pointer;font-size:15px;min-width:110px;
    transition:all .12s;
  }
  .scenarios button.active{
    background:linear-gradient(180deg,var(--brand),var(--brand-strong));
    color:#fff;box-shadow:0 6px 18px rgba(11,90,52,0.12);
    transform:translateY(-1px);
  }
  .messages{flex:1 1 auto;border-radius:10px;padding:14px;background:#fbfbfb;
    overflow:auto;border:1px solid rgba(10,10,10,0.04);box-sizing:border-box;}
  .msg{max-width:78%;padding:10px 12px;border-radius:10px;margin-bottom:10px;line-height:1.35;}
  .msg.bot{background:#eef9f6;color:#05332b;align-self:flex-start;}
  .msg.user{background:var(--brand);color:#fff;align-self:flex-end;text-align:right;}
  .input-area{margin-top:12px;position:sticky;bottom:0;padding-top:12px;z-index:2;background:var(--card);}
  .input-row{display:flex;gap:10px;align-items:center;}
  .input-row input[type="text"]{
    flex:1;padding:12px 14px;border-radius:10px;border:1px solid #e0e0e0;font-size:15px;box-sizing:border-box;}
  .btn{padding:11px 14px;border-radius:10px;background:var(--brand);color:#fff;border:0;cursor:pointer;font-size:15px;}
  .btn.ghost{background:transparent;color:var(--brand);border:1px solid rgba(11,90,52,0.08);}
  .input-row .btn.small{padding:10px 12px;}
  #overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(10,10,10,0.45);opacity:0;pointer-events:none;transition:opacity .18s ease;}
  #overlay.visible{opacity:1;pointer-events:auto;}
  .lead-card{
    width:520px;max-width:92%;background:var(--card);
    border-radius:12px;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,0.18);
    transform:translateY(-6px);opacity:0;transition:transform .2s ease,opacity .2s;position:relative;}
  #overlay.visible .lead-card{transform:none;opacity:1;}
  .lead-title{margin:0 0 12px;font-size:18px;color:var(--brand);font-weight:600;}
  .close-btn{all:unset;position:absolute;top:12px;right:12px;width:28px;height:28px;
    display:flex;align-items:center;justify-content:center;border-radius:50%;cursor:pointer;}
  .close-btn svg{width:18px;height:18px;stroke:#444;}
  .close-btn:hover{background:#f6f6f6;}
  .lead-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px;}
  .lead-grid .full{grid-column:1/-1;}
  input[type="text"],input[type="email"],input[type="tel"],select,textarea{
    width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;box-sizing:border-box;font-size:14px;}
  textarea{min-height:96px;resize:vertical;}
  .lead-submit{margin-top:8px;display:block;width:100%;padding:12px;font-size:15px;
    border-radius:8px;border:0;background:var(--brand);color:#fff;cursor:pointer;}
  .status{margin-top:8px;font-size:14px;color:var(--muted);text-align:center;}
  @media (max-width:640px){
    .lead-card{padding:16px;}
    .lead-grid{grid-template-columns:1fr;}
    .chat-box{height:calc(100vh - 48px);}
    .input-row{flex-direction:column;align-items:stretch;}
    .input-row .small{width:100%;}
  }
</style>
</head>
<body>
  <div class="page">
    <div class="chat-box" role="application" aria-label="Zizu chat">
      <div class="header">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 9.75L12 3l9 6.75v10.5a.75.75 0 0 1-.75.75h-5.25a.75.75 0 0 1-.75-.75V15a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75v5.25a.75.75 0 0 1-.75.75H3.75A.75.75 0 0 1 3 20.25V9.75z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <h1 class="title">Zizu Real Estate Assistant</h1>
      </div>

      <div class="scenarios" role="tablist">
        <button data-scenario="buy" class="scenario-btn">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 9.75L12 3l9 6.75v10.5a.75.75 0 0 1-.75.75h-5.25a.75.75 0 0 1-.75-.75V15a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75v5.25a.75.75 0 0 1-.75.75H3.75A.75.75 0 0 1 3 20.25V9.75z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Buy
        </button>
        <button data-scenario="rent" class="scenario-btn">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 7h16M4 12h16M4 17h16" stroke-width="1.5" stroke-linecap="round"/></svg>
          Rent
        </button>
        <button data-scenario="sell" class="scenario-btn">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 3h18M3 9h18M3 15h18M3 21h18" stroke-width="1.5" stroke-linecap="round"/></svg>
          Sell
        </button>
      </div>

      <div id="messages" class="messages" aria-live="polite" role="log"></div>

      <div class="input-area">
        <div class="input-row">
          <input id="userInput" type="text" placeholder="Please select a scenario above" autocomplete="off" />
          <button id="sendBtn" class="btn small" disabled>Send</button>
        </div>
        <div style="margin-top:8px; display:flex; gap:10px;">
          <button id="leadOpen" class="btn ghost">ðŸ“‹ Leave Contact</button>
        </div>
      </div>
    </div>
  </div>

  <div id="overlay" aria-hidden="true">
    <div class="lead-card" role="dialog" aria-modal="true" aria-labelledby="leadTitle">
      <button class="close-btn" id="leadClose" aria-label="Close">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 6l12 12M6 18L18 6" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
      <h3 id="leadTitle" class="lead-title">Leave your contact â€” our manager will contact you shortly</h3>

      <div class="lead-grid">
        <input id="leadName" type="text" placeholder="Your name" />
        <input id="leadEmail" type="email" placeholder="Email" />
        <input id="leadPhone" type="tel" placeholder="Phone number" />
        <select id="leadPlanning">
          <option value="">Planning horizon</option>
          <option value="urgent">Urgent</option>
          <option value="1-2">1â€“2 months</option>
          <option value="3-5">3â€“5 months</option>
        </select>
        <textarea id="leadDesc" class="full" placeholder="Brief description of the apartment and area"></textarea>
      </div>

      <button id="leadSubmit" class="lead-submit">Submit</button>
      <div id="leadStatus" class="status" aria-live="polite"></div>
    </div>
  </div>

<script>
  const messages=document.getElementById('messages');
  const userInput=document.getElementById('userInput');
  const sendBtn=document.getElementById('sendBtn');
  const scenarioButtons=document.querySelectorAll('.scenario-btn');
  const leadOpen=document.getElementById('leadOpen');
  const overlay=document.getElementById('overlay');
  const leadClose=document.getElementById('leadClose');
  const leadSubmit=document.getElementById('leadSubmit');
  const leadStatus=document.getElementById('leadStatus');
  let sessionId='sess_'+Date.now();
  let currentScenario=null;
  let messageCount=0;
  function appendMessage(text,from='bot'){
    const el=document.createElement('div');
    el.className='msg '+(from==='user'?'user':'bot');
    el.textContent=text;
    el.style.alignSelf=(from==='user')?'flex-end':'flex-start';
    messages.appendChild(el);
    messages.scrollTop=messages.scrollHeight;
  }
  scenarioButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      scenarioButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const scenario=btn.dataset.scenario;
      currentScenario=scenario;
      userInput.placeholder=(scenario==='buy')?'Search properties, e.g. 2-bed apartment':
        (scenario==='rent')?'Specify area, bedrooms, timeline':'Tell us about the property you want to sell';
      userInput.disabled=false;
      sendBtn.disabled=true;
      if(scenario==='buy') appendMessage("Hello! I'm Zizu â€” I can help you find apartments, villas and compounds to purchase. Where would you like to start?");
      if(scenario==='rent') appendMessage("Hi! I'll help with rentals. Which area and how many bedrooms?");
      if(scenario==='sell'){openLead();appendMessage("To sell â€” please leave contact details and a brief description in the form.");}
    });
  });
  userInput.addEventListener('input',()=>{sendBtn.disabled=!userInput.value.trim();});
  sendBtn.addEventListener('click',sendMessage);
  userInput.addEventListener('keypress',e=>{if(e.key==='Enter'){e.preventDefault();if(!sendBtn.disabled)sendMessage();}});
  async function sendMessage(){
    const text=userInput.value.trim();if(!text)return;
    appendMessage(text,'user');userInput.value='';sendBtn.disabled=true;messageCount++;
    if(messageCount%4===0)openLead();
    try{
      const res=await fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({message:text,sessionId,scenario:currentScenario})});
      if(!res.ok)throw new Error('server '+res.status);
      const data=await res.json();
      appendMessage(data.reply||'No reply from server.');
      if(data.showContactForm)openLead();
    }catch(err){console.warn('chat fetch failed:',err);
      setTimeout(()=>appendMessage("Thanks â€” we'll review this and get back to you soon."),450);}
  }
  function openLead(){overlay.classList.add('visible');overlay.setAttribute('aria-hidden','false');setTimeout(()=>document.getElementById('leadName').focus(),120);}
  function closeLead(){overlay.classList.remove('visible');overlay.setAttribute('aria-hidden','true');}
  leadOpen.addEventListener('click',openLead);
  leadClose.addEventListener('click',closeLead);
  overlay.addEventListener('click',e=>{if(e.target===overlay)closeLead();});
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeLead();});
  leadSubmit.addEventListener('click',async()=>{
    leadStatus.textContent='';
    const name=document.getElementById('leadName').value.trim();
    const email=document.getElementById('leadEmail').value.trim();
    const phone=document.getElementById('leadPhone').value.trim();
    const planning=document.getElementById('leadPlanning').value;
    const desc=document.getElementById('leadDesc').value.trim();
    const emailRe=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if(!name||!emailRe.test(email)||!phone){leadStatus.textContent='Please enter a valid name, email and phone.';return;}
    leadStatus.textContent='Sending...';
    try{
      const res=await fetch('/lead',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name,email,phone,planning,desc,sessionId,scenario:currentScenario})});
      if(!res.ok)throw new Error('lead send failed '+res.status);
      leadStatus.textContent='Thanks â€” we will contact you soon.';
      setTimeout(()=>{leadStatus.textContent='';closeLead();},1200);
    }catch(err){console.warn('lead send failed',err);leadStatus.textContent='Error sending lead â€” please try again later.';}
  });
  appendMessage('Welcome! Choose Buy / Rent / Sell to start.','bot');
</script>
</body>
</html>
